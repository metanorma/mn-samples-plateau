[[tocS_03]]
=== 標準的な作業手順


==== 幾何オブジェクトの作成

作成に必要となる原典資料を<<tab-S-3>>に示す。

[[tab-S-3]]
[cols="1a,8a"]
.地形モデルの原典資料（幾何オブジェクト）
|===
h| ^h| 高さを含む座標データ
h| LOD0 | 都市計画基本図等のDMデータ
h| LOD1
| 以下のいずれかのデータを一つ以上使用する。

* 基盤地図情報（標高モデル）
* 航空写真
* 航空レーザ点群

h| LOD2
| 以下のいずれかのデータを一つ以上使用する。

* 航空写真
* 航空レーザ点群

h| LOD3
| 以下のいずれかのデータを一つ以上使用する。

* 航空写真
* 航空レーザ点群
* MMS点群
* 地上レーザ点群

|===

NOTE: MMS点群及び地上レーザ点群は広域な範囲を網羅的に実施する航空測量とは異なり、局所的な計測となるため、地形モデルが対象範囲を包括するかを確認する必要がある。対象範囲を包括しない場合は別の測量成果を併用する必要がある。

===== LOD0

====== 地形モデル（LOD）の原典資料

[cols="1a,8a"]
|===
| |  高さを含む座標データ

h| LOD0 | 都市計画基本図等のDMデータ

|===

====== 地形モデル（LOD0）の作成手順

. DMデータより、地形に該当するデータを抽出する。 +
地形モデル（LOD0）は、公共測量標準図式に従った表現である。よって、DMデータから、地形に該当する分類コードが付与されたデータを抽出する。 +
<<tab-S-4>>に地形に関する公共測量標準図式の分類コードと示す。ただし、都市により独自の分類コードを使用していることがあるため、都市ごとの公共測量作業規程を確認する必要がある。

[[tab-S-4]]
[cols="1a,4a,4a"]
.地形に該当する公共測量標準図式の分類コード
|===
h| 分類コード h| 名称 h| 対応するクラス
| 7101 | 等高線（計曲線） | dem::BreaklineRelief
| 7102 | 等高線（主曲線） | dem::BreaklineRelief
| 7103 | 等高線（補助曲線） | dem::BreaklineRelief
| 7105 | 凹地（計曲線） | dem::BreaklineRelief
| 7106 | 凹地（主曲線） | dem::BreaklineRelief
| 7107 | 凹地（補助曲線） | dem::BreaklineRelief
| 7199 | 凹地（矢印） | dem::BreaklineRelief
| 7201 | 土がけ（崩土） | dem::BreaklineRelief
| 7202 | 雨裂 | dem::BreaklineRelief
| 7206 | 洞口 | dem::BreaklineRelief
| 7211 | 岩がけ | dem::BreaklineRelief
| 7212 | 露岩 | dem::BreaklineRelief
.2+| 7213 .2+| 散岩 | dem::BreaklineRelief （線で取得する場合）
| dem::MassPointRelief（点で取得する場合）
| 7214 | さんご礁 | dem::BreaklineRelief
| 7311 | 標石を有しない標高点 | dem::MassPointRelief
| 7312 | 図化機測定による標高点 | dem::MassPointRelief

|===

===== LOD1

====== 地形モデル（LOD1）の原典資料

[cols="1a,8a"]
|===
| |  高さを含む座標データ

h| LOD1 | 以下のいずれかのデータを一つ以上使用する

* 基盤地図情報（標高モデル）
* 航空写真
* 航空レーザ点群

|===

====== 地形モデル（LOD1）の作成手順（dem:TINRelief）

. 原典資料を入手する。 +
地形モデル（LOD1）は、基盤地図情報（標高モデル）からのデータ変換により作成することを基本とする。 +
ただし、基盤地図情報（標高モデル）の作成時期よりも新しい航空レーザ点群がある場合には、この航空レーザ点群を使用できる。既存の都市オブジェクトがある場合には、その都市オブジェクトの底面の高さは既存の地形モデルに依存しているため、新しい航空レーザ点群で作成される地形モデルと整合しない（既存の都市オブジェクトが、新しい航空レーザから作成された地形モデルから浮かんだり、沈んだりする）場合があることに留意する +
また、水部以外で基盤地図情報（標高モデル）や航空レーザ点群のデータがない場合は、航空写真の三次元図化で取得したブレークライン（傾斜が急激に変化する地点で高さを取得し、この地点をつないで作成した折れ線）を用いて欠落している範囲の標高モデル（DEM）を作成し、既存データと合成する。
. a）で入手又は作成したデータからTINを作成する。 +
DEMからTINを作成する。ただし、水部ではTINを作成しない。 +
基盤地図情報（標高モデル）から作成する場合、欠落部の標高値に-9999が設定されているため、その点群を除去しTINを作成する。航空写真から作成する場合は、水涯線を図化し水涯線までのTINを作成し、航空レーザ点群から作成する場合は、水部ポリゴンデータ（作業規程の準則の第554条に定める、航空レーザ用写真地図データを用いて水部の範囲を対象に作成したポリゴンデータ）までのTINを作成する。

====== 地形モデル（LOD1）の作成手順（dem:MassPointRelief）

. 原典資料を入手する。 +
地形モデル（LOD1）は、基盤地図情報（標高モデル）からのデータ変換により作成することを基本とする。 +
ただし、基盤地図情報（標高モデル）の作成時期よりも新しい航空レーザ点群がある場合は、この航空レーザ点群を使用できる。既存の都市オブジェクトがある場合には、その都市オブジェクトの底面の高さは既存の地形モデルに依存しているため、新しい航空レーザ点群で作成される地形モデルと整合しない（既存の都市オブジェクトが、新しい航空レーザから作成された地形モデルから浮かんだり、沈んだりする）場合があることに留意する。 +
また、水部以外で基盤地図情報（標高モデル）や航空レーザ点群のデータがない場所は、航空写真の三次元図化で取得したブレークライン（傾斜が急激に変化する地点で高さを取得し、この地点をつないで作成した折れ線）を用いて欠落した範囲のDEMを作成し、既存データと合成する。
. 地形の外形を多角形で取得する。 +
ランダム点群の場合、点の集合から地形モデルの範囲を正確に取得できない。そのため地形の外側の境界（dem:extentのexterior）を必ず作成する。地形の内空の境界（dem:extentのinterior）は任意で取得する。

===== LOD2

====== 地形モデル（LOD2）の原典資料

[cols="1a,8a"]
|===
| |  高さを含む座標データ

h| LOD2 | 以下のいずれかのデータを一つ以上使用する

* 航空写真
* 航空レーザ点群

|===

====== 地形モデル（LOD2）の作成手順（dem:TINRelief）

. 航空写真から作成した点群や航空レーザ点群を用いて、TINを作成する。

点群からTINを作成する。ただし、水部ではTINを作成しない。 +
航空写真から作成する場合は、水涯線を図化し水涯線までのTINを作成し、航空レーザ点群から作成する場合は、水部ポリゴンまでのTINを作成する。

====== 地形モデル（LOD2）の作成手順（dem:MassPointRelief）

. 航空写真から作成した点群や航空写真レーザ点群をデータ変換しdem:MassPointReliefを作成する。
. 地形の外形を多角形で取得する。

ランダム点群の場合、点の集合から地形モデルの範囲を正確に取得できない。そのため地形の外側の境界（dem:extentのexterior）を必ず作成する。地形の内空の境界（dem:extentのinterior）は任意で取得する。

===== LOD3

====== 地形モデル（LOD3）の原典資料

[cols="1a,8a"]
|===
| |  高さを含む座標データ

h| LOD3 | 以下のいずれかのデータを一つ以上使用する

* 航空写真
* 航空レーザ点群
* MMS点群
* 地上レーザ点群

|===

====== 地形モデル（LOD3）の作成手順

地形モデル（LOD2）の作成手順と同様となる。


==== 作業上の留意事項

===== 微小ポリゴンについて

3D都市モデルでは、地形モデルは基準地域メッシュ（第三次地域区画、一辺の長さ約1km）を地物の単位とする。 +
原典資料における地物の単位と異なる場合には、データ変換時に微小ポリゴンが生成される可能性がある。 +
そのため、論理一貫性における位相一貫性の検査（頂点間での距離が近接閾値未満の頂点の検出）を行い、閾値未満の頂点が検出された場合には頂点を統合する処理を行う。

===== TINの作成

TINの作成はソフトウェアによって、欠落部（河川等）の対岸までTINを生成する場合がある。その場合、生成されたTINから不要な辺を削除する必要がある。 +
不要な辺は、TINの三角形を構成する辺の正射影の長さが格子の斜辺の長さの最大値よりも長い辺を抽出することで特定できる。

[[fig-S-1]]
.TINを構成する不要な辺の特定イメージ
image::images/504.webp.png[width="500"]

===== 高密度点群データによる地形の表現

標準製品仕様書では、地形モデル（LOD1）から地形モデル（LOD3）までは、地形の作成に使用する原典資料の点密度又は標高点格子間隔により決定することとしている。原典資料として高密度点群データを使用する場合も、地形モデルのLOD定義に従った点密度に加工し、地形モデルを作成しなければならない。 +
そのうえで、原典資料と同様の高密度点群データを3D都市モデルに含めたい場合には、dem:MassPointReliefを使用し、地形モデルとして記述することができる。

===== ファイルの分割

3D都市モデルでは、一つの地物インスタンスに異なるLODの幾何オブジェクトを含めることで、同一の都市オブジェクトをマルチスケールで表現することが可能である。しかしながら、地形モデルの場合はインスタンスの単位が基準地域メッシュとなるため、一つの地物インスタンスに複数のLODの幾何オブジェクトを含めることでデータ量が膨大となり、操作性が低下する懸念がある。 +
そこで、地形モデルの中で最も詳細な地形表現が可能となる地形モデル（LOD3）は、ファイルを分けることを許容する。このとき、ファイル名にはオプションの文字列として、lod3を使用する。 +
なお、分割されたファイルに含まれるそれぞれの地物インスタンスのgml:nameには同じ基準地域メッシュのメッシュ番号が記載されるため、必要に応じて利用者側で一つの地物インスタンスに統合することが可能である。

