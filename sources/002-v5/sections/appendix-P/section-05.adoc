[[tocP_05]]
=== 繰り返しオブジェクト

繰り返しオブジェクト（ImplicitGeometry）は、地物毎に幾何オブジェクトを作成する代替として、一つのプロトタイプモデルを作成し、そのプロトタイプモデルを複数の地物が参照する仕組みである。地物毎に、どのプロトタイプモデルを使用するのか、どこに配置するのか、また、プロトタイプモデルをどう変形するのかを情報としてもつことができる。

CityGMLでは、都市設備（frn:CityFurniture）や単独木（ve:SolitaryVegetationObject）など特定の地物型が、繰り返しオブジェクトを使用可能と定義されている。例えば信号機のように、都市に複数設置されており、個々の形状が同じである地物の場合や、個々の形状は異なっていても、個々の形状の差異を表現することは不要な場合に、繰り返しオブジェクトを使用することでデータ量を軽減することができる。

[[fig-P-4]]
.繰り返しオブジェクトの利用イメージ
image::images/428.webp.png[width="300"]

しかしながら、ソフトウェアによりその仕様の解釈が異なり、3D都市モデルでは、変形のための変換行列の記述方法が一意に定まらないという課題があった。これは、3D都市モデルが採用する空間参照系が経緯度参照系であることに対し、プロトタイプモデルに適用される空間参照系が直交座標系であることが要因である。しかしながら、地下埋設物モデルは平面直角座標系を採用できることから、ソフトウェアによる解釈の違いの影響が生じず、変換行列の記述方法を一意に定めることができる。そこで、地下埋設物モデルを平面直角座標系で整備する場合に限定し、標準製品仕様書では繰り返しオブジェクトの使用を可としている。


[requirement]
.繰り返しオブジェクトの使用条件
====
[%metadata]
identifier:: /req/unf/7
subject:: 妥当な地下埋設物データセットの要件
description:: 繰り返しオブジェクトは空間参照系が平面直角座標系の場合のみ使用できる。
====


==== 繰り返しオブジェクトの座標の単位

地下埋設物モデルが採用する平面直角座標系の軸の単位はメートル（m）であることから、プロトタイプモデルの座標及び変換行列の単位もメートル（m）でなければならない。


[requirement]
.プロトタイプモデルの単位条件
====
[%metadata]
identifier:: /req/unf/8
subject:: 妥当な地下埋設物データセットの要件
description:: プロトタイプモデルの座標及び変換行列の単位はメートル（m）とする。
====


==== 繰り返しオブジェクトの指定

繰り返しオブジェクトは、GML形式以外の外部形式ファイルの参照（core:libraryObject）または、GML形式で記述された幾何オブジェクトの参照（core:relativeGMLGeometry）のいずれかを指定する。

繰り返しオブジェクトを外部形式ファイルの参照により指定する場合は、作成したプロトタイプモデルを地下埋設物モデル内のサブフォルダに格納し、属性core:libraryObjectではこのプロトタイプモデルへの相対パスにより所在を示す。


[requirement]
.プロトタイプモデルの参照条件
====
[%metadata]
identifier:: /req/unf/9
subject:: 妥当な地下埋設物データセットの要件
description:: 外部形式ファイルで記述されたプロトタイプモデルを参照する場合は、地下埋設物モデルを格納するunfフォルダにサブフォルダ（サブフォルダ名称：prototype）を格納し、相対パスにより参照する。
====

GML形式ファイルで記述された幾何オブジェクトをプロトタイプモデルとして使用する場合、3D都市モデルと同じファイルにプロトタイプとなる幾何オブジェクトを含めなければならない。このとき、３D都市モデルは平面直角座標系が適用されており、同一ファイルには同じ座標参照系しか適用してはならないことから、プロトタイプモデルも平面直角座標系で記述しなければならない。

そのため、実在する都市オブジェクトの幾何オブジェクトをプロトタイプモデルとし、ほかの都市オブジェクトからこの幾何オブジェクトを参照することが効率的である。


[requirement]
.GML形式のプロトタイプモデル記述条件
====
[%metadata]
identifier:: /req/unf/10
subject:: 妥当な地下埋設物データセットの要件
description:: GML形式でプロトタイプモデルを記述する場合は、3D都市モデルに含まれる都市オブジェクトの幾何オブジェクトを作成し、これをプロトタイプモデルとして使用する。
====


==== 繰り返しオブジェクトの実装例

<<fig-P-5>>は繰り返しオブジェクトの実装イメージである。給水栓などの設備（uro:Appurtenance）は、製品化されており、同じ型番の場合は形状も同じである。そこで、同じ製品が適用されている設備unf_01とurf_02については、幾何オブジェクトを作成せず、繰り返しオブジェクトを使用し、別途OBJ形式で作成されたプロトタイプモデル（appurtenance01.obj）を参照するとともに、実際に配置したい場所（core:referencePoint）を平面直角座標によりもつ。

二つの設備は、参照点しか測地座標をもたないが、プロトタイプモデルの各点に変換行列を乗じ、得られた各点の座標値に対して参照点の座標値を加えることで、実際の形状を得ることができる。

[[fig-P-5]]
.繰り返しオブジェクトの実装イメージ
image::images/429.webp.png[]
