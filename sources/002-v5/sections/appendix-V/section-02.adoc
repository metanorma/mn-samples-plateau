[[tocV_02]]
=== テクスチャマッピングのためのプロファイル

建築物等の都市オブジェクトをよりリアルに表現するために、コンクリート、タイル等のイメージ画像、あるいは実際に撮影された写真等の画像データを幾何オブジェクトに貼り付けることをテクスチャマッピングという。3D都市モデルにおいても、テクスチャマッピングに必要な情報を加えることができる。 +
テクスチャマッピングに必要な情報は、CityGMLのAppearanceモジュールに定義されている。標準製品仕様書では、画像データをテクスチャとして使用したり、都市オブジェクトの表面のマテリアルを指定したりする場合に使用するAppearanceモジュールのプロファイルとして、アピアランスモデルを定義している。 +
なお、このモジュールは外観だけではなく、例えば耐震診断や放射熱のシミュレーション結果を画像として壁面や屋根面と重ね合わせて表示する用途にも利用できる。


==== アピアランスモデル

建築物の壁面等の都市オブジェクトの表面にテクスチャを重畳する場合には、Appearanceモジュールに定義されたParameraterizedTextureを使用する。<<fig-V-1>>は、標準製品仕様書に示すAppearanceモジュールのUMLクラス図である。このUMLクラス図は、CityGMLのAppearanceモジュールから、ParameterizedTextureを使用するために必要となる型のみを矛盾なく抽出したプロファイルである。

[[fig-V-1]]
.テクスチャのためのプロファイル

image::images/EAID_C31C1314_B679_4413_B8FE_A2CD584FC128.png[]

// mage::images/519.svg[]

==== テクスチャの記述

アピアランスモデルより記述されるテクスチャマッピングの情報は、3D都市モデルの一部としてCityGML形式で記述する。

[source,xml]
----
<app:ParameterizedTexture>
  <app:imageURI>[テクスチャ画像への相対パス]</app:imageURI>
  <app:mimeType>[テクスチャ画像のファイルタイプ]</app:mimeType>
  <app:target uri="[テクスチャ画像を貼る対象となる面への参照">
	  <app:TexCoordList>
      <app:textureCoordinates ring="[テクスチャ画像を貼る対象となる面の外周への参照">[面の外周に対応するテクスチャ画像の座標]</app:textureCoordinates>
	  </app:TexCoordList>
  </app:target>
</app:ParameterizedTexture>
----

* app:imageURIには、参照するテクスチャ画像データのファイルの所在を、3D都市モデルファイルからの相対パスにより記述する。
** テクスチャ画像のファイルの格納については<<toc5_04_05>>フォルダ構成とフォルダ名称<<toc5_04_05_06>>テクスチャのフォルダ構成を参照すること。
** テクスチャ画像のパスにフォルダを複数階層、含んでもよいこととする。
* app:mimeTypeには、テクスチャ画像のファイルタイプを指定する。image/png又は、image/jpegのいずれかとなる。
* app:targetの属性uriには、テクスチャ画像を貼る対象となる面（gml:Polygon）のgml:idへの参照を記述する。
* app:textureCoordinatesの属性ringには、テクスチャ画像を貼る対象となる面の外周（gml:LinearRing）のgml:idへの参照を記述する。
* app:textureCoordinatesの値には、gml:LinearRingを構成する各座標に対応するテクスチャ画像の座標を列挙する。
** テクスチャ画像の座標として用いるUV座標は横方向をU軸、縦方向をV軸として、座標値は0から1の小数値を用いる。UV座標の定義は面ごとにU値、V値の順に、面の頂点定義の順に定義する。


==== Appearanceモジュール利用上の留意事項

* CityGMLでは、Appearanceモジュールには、テクスチャを記述する型として、GeoreferencedTextureも定義されている。ただし、GeoreferencedTextureは現時点でその実装例が存在しないため、3D都市モデルでは非推奨とする。
* 地形（dem:ReliefFeature）に重畳する画像の記述には、ParametarizedTextureは使用しない。地形に重畳する画像のデータ形式にはGeoTIFFを適用する。

[NOTE]
--
CityGMLでは、様々な地物型等が用意されているが、必ずしも全ての実装例が存在しているわけではない。例えば、地形に画像を貼りつける表示を行いたい場合は、別途GeoTIFF等の画像を用意し、ソフトウェア側でレンダリングを行うことが一般的である。そのため、GeoreferencedTextureは使用されていない。

そこで、3D都市モデルの成果物として地形に貼り付けるための画像（例：航空写真、衛星画像）を格納したい場合は、そのデータ形式としてOGCが策定した画像のための国際標準データ形式であるGeoTIFFを採用する。
--


==== 建築物モデルのテクスチャ作成における留意事項

===== テクスチャのマージン

テクスチャに用いる画像は、航空測量から取得した画像データのファイルから、対応する面に合わせて切り出した画像データを用いることを推奨する。建築物モデルで定義した面ごとにテクスチャに用いる画像を切り出す際には該当する面より外側の数ピクセル（2ピクセル程度）を含むようマージン（余裕）を設ける。マージン設定のイメージを<<fig-V-2>>に示す。

[[fig-V-2]]
.マージンの設定イメージ
image::images/520.webp.png[width="400"]

===== テクスチャのサイズ制限

テクスチャに用いる画像のサイズは、高さ及び幅の各辺長を2の累乗（8、64、128、256、512、1024、2048ピクセル）とし、2048ピクセル以下とすることを基本とする。ただし、大規模な建築物等では、上限を4096ピクセルとする。 +
なお、高さ及び幅が異なる辺長としてもよい。 +
テクスチャの解像度は10cm／pixel以下を基本とする。ただし、ユースケースが必要とする場合は10cm／pixel以上の高解像度画像を用いることも可能とするが、高解像画像を広域に用いた場合に描画負荷が大きいことに留意する。

===== テクスチャのファイル単位

テクスチャの作成に当たっては、描画性能の観点から複数の地物のテクスチャを一つの画像ファイルにまとめること（アトラス化）を推奨する。 +
アトラス化の範囲は、一つのCityGMLファイルを上限とする。アトラス化後の画像サイズは一辺2048ピクセル以下（辺長サイズは2の累乗）を推奨とし、一辺4096ピクセルを上限とする。ただし、大規模な地物などで、一つの地物でアトラス化をした際にアトラス化後のテクスチャサイズが画像サイズの上限（一辺4096ピクセル）を超える場合は、その地物の画像ファイルを分割してアトラス化してもよい。 +
複数の地物のテクスチャを一つの画像ファイルにまとめる場合は、地理的に近接した地物単位でまとめる。

===== アトラス化（テクスチャをまとめる）方法

アトラス化を行う場合は、元画像のテクスチャを回転や拡縮を行わずに規定サイズ内の長方形に詰め込み、テクスチャのUV座標を詰め込み後の画像のUV座標に置き換える手法とする。詰め込みは画像の左隅を起点（左上または左下）とする。 +
画像の背景色は、黒（R,G,B:0,0,0）とすることを基本とする。ただし、建築物モデルの色調を考慮し、灰色（R,G,B:90,90,90等）を設定してもよい。

