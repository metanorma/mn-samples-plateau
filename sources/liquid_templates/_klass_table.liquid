{% assign root = klass.generalization %}
{% assign citygml_ns = "app,bldg,brid,core,dem,frn,gen,grp,luse,tran,tun,veg,wtr" | split: "," %}
{%- capture upper_klass_name -%}
{{ root.general.upper_klass.name }}:{{ root.general.name }}
{%- endcapture -%}
{%- if upper_klass_name == ":" -%}
  {%- assign upper_klass_name = "&#x2014;" -%}
{%- endif -%}
{%- capture stereotype -%}<< {{ root.stereotype }} >>{%- endcapture -%}
{%- if stereotype == "<<  >>" -%}
  {%- assign stereotype = " " -%}
{%- endif -%}

{%- comment -%}
Build element mapping lookup table from YAML structure
Key format: "package|class|attribute" -> "target_type"
{%- endcomment -%}
{% assign element_mappings = "" | split: "" %}
{% assign mapping_keys = "bldg|AbstractBuilding|bldgDataQualityAttribute:uro:DataQualityAttribute,bldg|AbstractBuilding|bldgDisasterRiskAttribute:uro:DisasterRiskAttribute,bldg|AbstractBuilding|bldgDmAttribute:uro:DmAttribute,bldg|AbstractBuilding|bldgFacilityAttribute:uro:FacilityAttribute,bldg|AbstractBuilding|bldgFacilityIdAttribute:uro:FacilityIdAttribute,bldg|AbstractBuilding|bldgFacilityTypeAttribute:uro:FacilityTypeAttribute,bldg|AbstractBuilding|bldgKeyValuePairAttribute:uro:KeyValuePairAttribute,bldg|AbstractBuilding|bldgRealEstateIDAttribute:uro:RealEstateIDAttribute,bldg|AbstractBuilding|bldgUsecaseAttribute:uro:BuildingUsecaseAttribute,brid|AbstractBridge|bridBaseAttribute:uro:ConstructionBaseAttribute,brid|AbstractBridge|bridDataQualityAttribute:uro:DataQualityAttribute,brid|AbstractBridge|bridDisasterRiskAttribute:uro:DisasterRiskAttribute,brid|AbstractBridge|bridDmAttribute:uro:DmAttribute,brid|AbstractBridge|bridFacilityAttribute:uro:FacilityAttribute,brid|AbstractBridge|bridFacilityIdAttribute:uro:FacilityIdAttribute,brid|AbstractBridge|bridFacilityTypeAttribute:uro:FacilityTypeAttribute,brid|AbstractBridge|bridFunctionalAttribute:uro:BridgeFunctionalAttribute,brid|AbstractBridge|bridKeyValuePairAttribute:uro:KeyValuePairAttribute,brid|AbstractBridge|bridRiskAssessmentAttribute:uro:ConstructionRiskAssessmentAttribute,brid|AbstractBridge|bridStructureAttribute:uro:BridgeStructureAttribute,bldg|AbstractBuilding|buildingDetailAttribute:uro:BuildingDetailAttribute,bldg|AbstractBuilding|buildingIDAttribute:uro:BuildingIDAttribute,frn|CityFurniture|cityFurnitureDetailAttribute:uro:CityFurnitureDetailAttribute,dem|ReliefFeature|demDataQualityAttribute:uro:DataQualityAttribute,dem|ReliefComponent|demDmAttribute:uro:DmAttribute,dem|ReliefFeature|demKeyValuePairAttribute:uro:KeyValuePairAttribute,wtr|WaterBody|floodingRiskAttribute:uro:FloodingRiskAttribute,frn|CityFurniture|frnDataQualityAttribute:uro:DataQualityAttribute,frn|CityFurniture|frnDmAttribute:uro:DmAttribute,frn|CityFurniture|frnFacilityAttribute:uro:FacilityAttribute,frn|CityFurniture|frnFacilityIdAttribute:uro:FacilityIdAttribute,frn|CityFurniture|frnFacilityTypeAttribute:uro:FacilityTypeAttribute,frn|CityFurniture|frnKeyValuePairAttribute:uro:KeyValuePairAttribute,bldg|BoundarySurface|ifcBoundarySurfaceAttribute:uro:IfcAttribute,bldg|AbstractBuilding|ifcBuildingAttribute:uro:IfcAttribute,bldg|BuildingFurniture|ifcBuildingFurnitureAttribute:uro:IfcAttribute,bldg|BuildingInstallation|ifcBuildingInstallationAttribute:uro:IfcAttribute,grp|CityObjectGroup|ifcBuildingStoreyAttribute:uro:IfcAttribute,bldg|IntBuildingInstallation|ifcIntBuildingInstallationAttribute:uro:IfcAttribute,luse|LandUse|ifcLandUseAttribute:uro:IfcAttribute,bldg|Opening|ifcOpeningAttribute:uro:IfcAttribute,bldg|Room|ifcRoomAttribute:uro:IfcAttribute,bldg|BoundarySurface|indoorBoundarySurfaceAttribute:uro:IndoorAttribute,bldg|AbstractBuilding|indoorBuildingAttribute:uro:IndoorAttribute,bldg|BuildingFurniture|indoorFurnitureAttribute:uro:IndoorAttribute,bldg|IntBuildingInstallation|indoorIntInstallationAttribute:uro:IndoorAttribute,bldg|Opening|indoorOpeningAttribute:uro:IndoorAttribute,bldg|Room|indoorRoomAttribute:uro:IndoorAttribute,grp|CityObjectGroup|indoorStoreyAttribute:uro:IndoorAttribute,luse|LandUse|landUseDetailAttribute:uro:LandUseDetailAttribute,bldg|AbstractBuilding|largeCustomerFacilityAttribute:uro:LargeCustomerFacilityAttribute,luse|LandUse|luseDataQualityAttribute:uro:DataQualityAttribute,luse|LandUse|luseDmAttribute:uro:DmAttribute,luse|LandUse|luseFacilityAttribute:uro:FacilityAttribute,luse|LandUse|luseFacilityIdAttribute:uro:FacilityIdAttribute,luse|LandUse|luseFacilityTypeAttribute:uro:FacilityTypeAttribute,luse|LandUse|luseKeyValuePairAttribute:uro:KeyValuePairAttribute,core|CityObject|pointCloud:uro:AbstractPointCloud,tran|Railway|railwayRouteAttribute:uro:RailwayRouteAttribute,tran|TrafficArea|railwayTrackAttribute:uro:RailwayTrackAttribute,tran|Road|roadStatus:uro:RoadType,tran|Road|roadStructureAttribute:uro:RoadStructureAttribute,tran|Square|squareUrbanPlanAttribute:uro:SquareUrbanPlanAttribute,tran|Track|trackAttribute:uro:TrackAttribute,tran|TrafficArea|trafficAreaStructureAttribute:uro:TrafficAreaStructureAttribute,tran|Road|trafficVolumeAttribute:uro:TrafficVolumeAttribute,tran|TransportationComplex|tranDataQualityAttribute:uro:DataQualityAttribute,tran|TransportationComplex|tranDmAttribute:uro:DmAttribute,tran|TransportationComplex|tranFacilityAttribute:uro:FacilityAttribute,tran|TransportationComplex|tranFacilityIdAttribute:uro:FacilityIdAttribute,tran|TransportationComplex|tranFacilityTypeAttribute:uro:FacilityTypeAttribute,tran|TransportationComplex|tranKeyValuePairAttribute:uro:KeyValuePairAttribute,tran|TransportationComplex|tranUsecaseAttribute:uro:TrafficObjectUsecaseAttribute,tun|AbstractTunnel|tunBaseAttribute:uro:ConstructionBaseAttribute,tun|AbstractTunnel|tunDataQualityAttribute:uro:DataQualityAttribute,tun|AbstractTunnel|tunDisasterRiskAttribute:uro:DisasterRiskAttribute,tun|AbstractTunnel|tunDmAttribute:uro:DmAttribute,tun|AbstractTunnel|tunFacilityAttribute:uro:FacilityAttribute,tun|AbstractTunnel|tunFacilityIdAttribute:uro:FacilityIdAttribute,tun|AbstractTunnel|tunFacilityTypeAttribute:uro:FacilityTypeAttribute,tun|AbstractTunnel|tunFunctionalAttribute:uro:TunnelFunctionalAttribute,tun|AbstractTunnel|tunKeyValuePairAttribute:uro:KeyValuePairAttribute,tun|AbstractTunnel|tunRiskAssessmentAttribute:uro:ConstructionRiskAssessmentAttribute,tun|AbstractTunnel|tunStructureAttribute:uro:TunnelStructureAttribute,veg|VegetationObject|vegDataQualityAttribute:uro:DataQualityAttribute,veg|VegetationObject|vegDmAttribute:uro:DmAttribute,veg|VegetationObject|vegFacilityAttribute:uro:FacilityAttribute,veg|VegetationObject|vegFacilityIdAttribute:uro:FacilityIdAttribute,veg|VegetationObject|vegFacilityTypeAttribute:uro:FacilityTypeAttribute,veg|VegetationObject|vegKeyValuePairAttribute:uro:KeyValuePairAttribute,wtr|WaterBody|waterBodyDetailAttribute:uro:WaterBodyDetailAttribute,wtr|WaterBody|wtrDataQualityAttribute:uro:DataQualityAttribute,wtr|WaterBody|wtrDmAttribute:uro:DmAttribute,wtr|WaterBody|wtrFacilityAttribute:uro:FacilityAttribute,wtr|WaterBody|wtrFacilityIdAttribute:uro:FacilityIdAttribute,wtr|WaterBody|wtrFacilityTypeAttribute:uro:FacilityTypeAttribute,wtr|WaterBody|wtrKeyValuePairAttribute:uro:KeyValuePairAttribute" | split: "," %}

{%- if klass.has_guidance? -%}
  {%- assign cols_format = "1a,1a,2a,1a" -%}
  {%- assign cols_number = 4 -%}
  {%- assign cols_header = 3 -%}
{%- else -%}
  {%- assign cols_format = "1a,1a,2a" -%}
  {%- assign cols_number = 3 -%}
  {%- assign cols_header = 2 -%}
{%- endif -%}

[cols="{{ cols_format }}"]
|===
h| 型の定義 {{ cols_header }}+| {{ root.definition }}
h| 上位の型 {{ cols_header }}+| {{ upper_klass_name }}
h| ステレオタイプ {{ cols_header }}+| {{ stereotype }}

{% if root.inherited_props.size > 0 %}
{{ cols_number }}+h| 継承する属性
h| 属性名 h| 属性の型及び多重度 h| 定義 {% if klass.has_guidance? %} h| 補足{%- endif %}
{% endif %}
{% for attr in root.inherited_props %}
{% assign attr_upper_klass_name = attr.upper_klass.absolute_path | split: "::" | last %}
{%- capture name_col -%}
  {%- if attr.used? == false -%}
    ({{ attr_upper_klass_name }}:{{ attr.name }}) +
    [{{ attr_upper_klass_name }}::{{ attr.gen_name }}]
  {%- else -%}
    {{ attr_upper_klass_name }}:{{ attr.name }} +
    [{{ attr_upper_klass_name }}::{{ attr.gen_name }}]
  {%- endif -%}
{%- endcapture -%}
| {{ name_col }}
| {{ attr.type }} [{{ attr.cardinality.min }}..{{ attr.cardinality.max }}]
| {{ attr.definition }}
{% if klass.has_guidance? -%} | {{ attr.guidance }}{%- endif %}{% if attr.used? == false %}tr-style:[background-color: grey]{% endif %}
{% endfor %}

{% if root.owned_props.size > 0 %}
{{ cols_number }}+h| 自身に定義された属性
h| 属性名 h| 属性の型及び多重度 h| 定義 {% if klass.has_guidance? %} h| 補足{%- endif %}
{% endif %}
{% for attr in root.owned_props %}
{% assign attr_upper_klass_name = attr.upper_klass.absolute_path | split: "::" | last %}
{%- capture name_col -%}
  {%- if attr.used? == false -%}
    ({{ attr_upper_klass_name }}:{{ attr.name }}) +
    [{{ attr_upper_klass_name }}::{{ attr.gen_name }}]
  {%- else -%}
    {{ attr_upper_klass_name }}:{{ attr.name }} +
    [{{ attr_upper_klass_name }}::{{ attr.gen_name }}]
  {%- endif -%}
{%- endcapture -%}
| {{ name_col }}
| {{ attr.type }} [{{ attr.cardinality.min }}..{{ attr.cardinality.max }}]
| {{ attr.definition }}
{% if klass.has_guidance? -%} | {{ attr.guidance }}{%- endif %}{% if attr.used? == false %}tr-style:[background-color: grey]{% endif %}
{% endfor %}

{% if root.sorted_inherited_assoc_props.size > 0 %}
{{ cols_number }}+h| 継承する関連役割
h| 関連役割名 h| 関連役割の型及び多重度 h| 定義 {% if klass.has_guidance? %} h| 補足{%- endif %}
{% assign all_gen_names = '' %}
{% for attr in root.sorted_inherited_assoc_props %}
  {% assign all_gen_names = all_gen_names | append: ',' | append: attr.gen_name %}
{% endfor %}  
{% assign all_gens = all_gen_names | split: ',' | uniq %}
{% endif %}
{% for cur_gen in all_gens %}
  {% assign performed = false %}
  {% for attr in root.sorted_inherited_assoc_props %}
    {% assign props_with_same_gen = root.sorted_inherited_assoc_props | where: 'gen_name', cur_gen %}
    {% unless performed %}
      {% for attr in props_with_same_gen %}
        {% assign attr_upper_klass_name = attr.upper_klass.absolute_path | split: "::" | last %}
        {% if attr.type_ns == "gen" %}
          {% assign attr_upper_klass_name = "gen" %}
        {% endif %}
        {% if attr_upper_klass_name == "uro" or citygml_ns contains attr_upper_klass_name %}

        {%- capture default_name_col_role_and_name -%}
          {{ attr_upper_klass_name }}:{{ attr.name }}
        {%- endcapture -%}

        {%- capture type_col_role_and_name -%}
          {{ attr.type_ns }}:{{ attr.type }}
        {%- endcapture -%}

        {%- comment -%}Dynamic mapping lookup based on package, class, and attribute{%- endcomment -%}
        {% assign name_col_role_and_name = default_name_col_role_and_name %}
        {% assign klass_name = klass.name %}
        {% for mapping_entry in mapping_keys %}
          {% assign entry_parts = mapping_entry | split: ":" %}
          {% assign lookup_key = entry_parts[0] %}
          {% assign target_value = entry_parts[1] | prepend: ":" | prepend: entry_parts[1] | split: "|" | last | split: ":" | first | prepend: ":" | prepend: entry_parts[1] | split: ":" | slice: 0, 2 | join: ":" %}
          {% assign key_parts = lookup_key | split: "|" %}
          {% if key_parts.size == 3 %}
            {% assign map_package = key_parts[0] %}
            {% assign map_class = key_parts[1] %}
            {% assign map_attr = key_parts[2] %}
            {% if attr_upper_klass_name == map_package and klass_name == map_class and attr.name == map_attr %}
              {% assign name_col_role_and_name = entry_parts[1] %}
              {% break %}
            {% endif %}
          {% endif %}
        {% endfor %}

        {%- capture name_col -%}
          {%- if attr.used? == false -%}
            ({{  name_col_role_and_name }}) +
            [{{ attr_upper_klass_name }}::{{ attr.gen_name }}]
          {%- else -%}
            {{  name_col_role_and_name }} +
            [{{ attr_upper_klass_name }}::{{ attr.gen_name }}]
          {%- endif -%}
        {%- endcapture -%}
        | {{ name_col }}
        | {{ attr.type_ns }}:{{ attr.type }} [{{ attr.cardinality.min }}..{{ attr.cardinality.max }}]
        | {{ attr.definition }}
        {% if klass.has_guidance? -%} | {{ attr.guidance }}{%- endif %}{% if attr.used? == false %}tr-style:[background-color: grey]{% endif %}
        {% endif %}
      {% endfor %}
      {% for attr in props_with_same_gen %}
        {% assign attr_upper_klass_name = attr.upper_klass.absolute_path | split: "::" | last %}
        {% unless citygml_ns contains attr_upper_klass_name %}
        {%- capture name_col -%}
          {%- if attr.used? == false -%}
            ({{ attr_upper_klass_name }}:{{ attr.name }}) +
            [{{ attr_upper_klass_name }}::{{ attr.gen_name }}]
          {%- else -%}
            {{ attr_upper_klass_name }}:{{ attr.name }} +
            [{{ attr_upper_klass_name }}::{{ attr.gen_name }}]
          {%- endif -%}
        {%- endcapture -%}
        | {{ name_col }}
        | {{ attr.type_ns }}:{{ attr.type }} [{{ attr.cardinality.min }}..{{ attr.cardinality.max }}]
        | {{ attr.definition }}
        {% if klass.has_guidance? -%} | {{ attr.guidance }}{%- endif %}{% if attr.used? == false %}tr-style:[background-color: grey]{% endif %}
        {% endunless %}
      {% endfor %}
      {% assign performed = true %}
    {% endunless %}
  {% endfor %}
{% endfor %}

{% if root.sorted_assoc_props.size > 0 %}
{{ cols_number }}+h| 自身に定義された関連役割
h| 関連役割名 h| 関連役割の型及び多重度 h| 定義 {% if klass.has_guidance? %} h| 補足{%- endif %}
{% assign all_gen_names = '' %}
{% for attr in root.sorted_assoc_props %}
  {% assign all_gen_names = all_gen_names | append: ',' | append: attr.gen_name %}
{% endfor %}  
{% assign all_gens = all_gen_names | split: ',' | uniq %}
{% endif %}
{% for cur_gen in all_gens %}
  {% assign performed = false %}
  {% for attr in root.sorted_assoc_props %}
    {% assign props_with_same_gen = root.sorted_assoc_props | where: 'gen_name', cur_gen %}
    {% unless performed %}
      {% for attr in props_with_same_gen %}
        {% assign attr_upper_klass_name = attr.upper_klass.absolute_path | split: "::" | last %}
        {% if attr.type_ns == "gen" %}
          {% assign attr_upper_klass_name = "gen" %}
        {% endif %}
        {% if attr_upper_klass_name == "uro" or citygml_ns contains attr_upper_klass_name %}

        {%- capture default_name_col_role_and_name -%}
          {{ attr_upper_klass_name }}:{{ attr.name }}
        {%- endcapture -%}

        {%- capture type_col_role_and_name -%}
          {{ attr.type_ns }}:{{ attr.type }}
        {%- endcapture -%}

        {%- comment -%}Dynamic mapping lookup based on package, class, and attribute{%- endcomment -%}
        {% assign name_col_role_and_name = default_name_col_role_and_name %}
        {% assign klass_name = klass.name %}
        {% for mapping_entry in mapping_keys %}
          {% assign entry_parts = mapping_entry | split: ":" %}
          {% assign lookup_key = entry_parts[0] %}
          {% assign target_value = entry_parts[1] | prepend: ":" | prepend: entry_parts[1] | split: "|" | last | split: ":" | first | prepend: ":" | prepend: entry_parts[1] | split: ":" | slice: 0, 2 | join: ":" %}
          {% assign key_parts = lookup_key | split: "|" %}
          {% if key_parts.size == 3 %}
            {% assign map_package = key_parts[0] %}
            {% assign map_class = key_parts[1] %}
            {% assign map_attr = key_parts[2] %}
            {% if attr_upper_klass_name == map_package and klass_name == map_class and attr.name == map_attr %}
              {% assign name_col_role_and_name = entry_parts[1] %}
              {% break %}
            {% endif %}
          {% endif %}
        {% endfor %}

        {%- capture name_col -%}
          {%- if attr.used? == false -%}
            ({{ name_col_role_and_name }}) +
            [{{ attr_upper_klass_name }}::{{ attr.gen_name }}]
          {%- else -%}
            {{ name_col_role_and_name }} +
            [{{ attr_upper_klass_name }}::{{ attr.gen_name }}]
          {%- endif -%}
        {%- endcapture -%}
        | {{ name_col }}
        | {{ attr.type_ns }}:{{ attr.type }} [{{ attr.cardinality.min }}..{{ attr.cardinality.max }}]
        | {{ attr.definition }}
        {% if klass.has_guidance? -%} | {{ attr.guidance }}{%- endif %}{% if attr.used? == false %}tr-style:[background-color: grey]{% endif %}
        {% endif %}
      {% endfor %}
      {% for attr in props_with_same_gen %}
        {% assign attr_upper_klass_name = attr.upper_klass.absolute_path | split: "::" | last %}
        {% unless citygml_ns contains attr_upper_klass_name %}
        {%- capture name_col -%}
          {%- if attr.used? == false -%}
            ({{ attr_upper_klass_name }}:{{ attr.name }}) +
            [{{ attr_upper_klass_name }}::{{ attr.gen_name }}]
          {%- else -%}
            {{ attr_upper_klass_name }}:{{ attr.name }} +
            [{{ attr_upper_klass_name }}::{{ attr.gen_name }}]
          {%- endif -%}
        {%- endcapture -%}
        | {{ name_col }}
        | {{ attr.type_ns }}:{{ attr.type }} [{{ attr.cardinality.min }}..{{ attr.cardinality.max }}]
        | {{ attr.definition }}
        {% if klass.has_guidance? -%} | {{ attr.guidance }}{%- endif %}{% if attr.used? == false %}tr-style:[background-color: grey]{% endif %}
        {% endunless %}
      {% endfor %}
      {% assign performed = true %}
    {% endunless %}
  {% endfor %}
{% endfor %}
|===
